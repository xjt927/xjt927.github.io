---
title: 2.分布式理论：CAP定理
abbrlink: 9awc662
date: 2020-07-10 10:14:56
tags: 分布式
categories: 分布式
keywords: 分布式,cap
---
CAP定理的含义

> 2000 年7月的时候，加州大学伯克利分校的Eric Brewer 教授提出了 CAP 猜想，2年后，被 来自于麻省理工的Seth Gilbert 和 Nancy Lynch 从理论上证明了猜想的可能性，从此，CAP 定理正式在学术上成为了分布式计算领域的公认定理。并深深的影响了分布式计算的发展。



CAP 理论含义是：一个分布式系统不可能同时满足一致性（C:Consistency)，可用性（A: Availability）和分区容错性（P：Partition tolerance）这三个基本需求，**最多只能同时满足其中的2个**。



| 指标 | 选项         | 描述 |
| ------------ || ------------ | :----------------------------------------------------------- | ---- |
|Consistency | C 一致性     | 分布式系统当中的一致性指的是所有节点的数据一致，或者说是所有副本的数据一致 |
|Consistency | A 可用性     | Reads and writes always succeed. 也就是说系统一直可用，而且服务一直保持正常 |
|Partition tolerance | P 分区容错性 | 系统在遇到一些节点或者网络分区故障的时候，仍然能够提供满足一致性和可用性的服务 |

这里说的一致性，是指强一致性。



![e91fb6a1-b4f4-a6e0-5f85-6b021cb1d6a8.png](http://blog.xuejiangtao.com/blog/20200702/e91fb6a1-b4f4-a6e0-5f85-6b021cb1d6a8.png)



## C - Consistency 一致性

一致性是指写操作后，读取数据时在分布式任意节点读取的数据都是最新的、一样的。

### 1.分布式一致性特点：

1. 由于一致性同步数据，需要等待同步完成，所以写操作会有延迟。
2. 同步数据时需要锁上资源。
3. 如果请求同步数据失败的节点，则返回错误信息，一定不会返回旧数据。



### 2.如何实现一致性？

1. 写入主数据库后，保证能同步到从数据库。

2. 写入主数据库后在向从数据库同步数据时，要把从数据库锁上，数据同步完成后再释放锁，避免写入新数据后在从数据库读出旧数据。



## A - Availability 可用性

可用性是指任何操作都可以得到响应结果，不会出现响应超时，或响应错误。



### 1.分布式可用性特点：

1. 从数据库接到查询请求时，立即响应查询数据返回结果。
2. 从数据库不允许响应超时或响应失败。



### 2.如何实现可用性？

1. 写入主数据库后将数据同步到从数据库。
2. 为了保证可用性，同步数据时不能锁定从数据库。
3. 即使主数据库的新数据没有同步过来，也要及时响应哪怕是旧数据，不能出现响应超时和响应错误。



## P - Partition tolerance 分区容错性

由于分布式系统通过网络和各个节点交互，所以必然存在网络通信问题，导致通信失败。容错性是指**在通信失败的情况下，依然可以对外提供服务。**



### 1.分布式容错性特点：

1. 主数据库在向从数据库同步数据失败时，不影响主数据库的写操作。
2. 分布式其中一个节点挂掉，不影响其他节点提供服务。



### 2.如何实现分区容错性？

1. 使用异步方式将主数据库数据同步到从数据库。
2. 增加数据库节点，其中一个数据库节点挂掉不影响其他节点提供数据。

## CAP定理只能3选2

![066565e9-8d12-ef23-270a-515525f45516.png](http://blog.xuejiangtao.com/blog/20200702/066565e9-8d12-ef23-270a-515525f45516.png)

### 为啥三个指标不能同时可用？

先来介绍以下cap定理，可用性是指不管任何时候都能查到数据。一致性是指所有节点数据都是相同的、最新的。分区容错性是指在节点宕机、或通信失败的情况下，分布式系统依然可以对外提供服务。

**所以，在分布式系统中分区容错性肯定是要保证实现的。既然存在宕机或通信失败，这种情况只能在一致性和可用性之间选择一个保证实现。**

**要么牺牲掉一致性，保证可用性；要么牺牲掉可用性，保证一致性。**

**否则在节点宕机或通信失败的情况下，既要保证一致性，又要保证可用性，是根本不可能实现的。**



### 3选2的情况

1. 既然是分布式系统，节点间就要交互，交互就可能出现丢包、网络不通，节点宕机等情况。这样就不能保证数据一致性，会牺牲掉C一致性，剩下AP。

2. 如果要实现数据一致性，则必然要牺牲A可用性，因为同步数据会锁数据库，同步一直不成功则一直锁库查不到数据，无法保证可用性，剩下CP。
3. 只有在单机模式下才能实现CA，那这样就不是分布式系统，一般不用CA，而更多使用AP，CP。



**注：**

> **在分布式中CA组合是相克的，不可能既要保证一致性，又要保证可用性。**



## 介绍CP，AP使用场景？

CP：放弃可用性，追求一致性和分区容错性。Zookeeper为CP设计。

AP：放弃一致性，追求可用性和分区容错性。Eureka为AP设计。