---
title: 分布式系统设计策略
abbrlink: 6j507e72
date: 2020-9-2 23:30:44
tags: 分布式
categories: 分布式
keywords: 分布式
---
在分布式环境下，有几个问题是普遍关心的，我们称之为设计策略：

- 如何检测当前节点还活着？
- 如何保障高可用？
- 容错处理
- 负载均衡

## 1.心跳检测

心跳顾名思义，就是以固定的频率向其他节点汇报当前节点状态的方式。收到心跳，一般可以认为一个节点和现在的网络拓扑是良好的。当然，心跳汇报时，一般也会携带一些附加的状态、元数据信息，以便管理。

<img src="http://blog.xuejiangtao.com/blog/20200708/jmqsqrx70vQb.png?imageslim" alt="mark" style="zoom: 30%;" />

若Server没有收到Node3的心跳时，Server认为Node3失联。但是失联是失去联系，并不确定是否是Node3故障，有可能是Node3处于繁忙状态，导致调用检测超时；也有可能是Server与Node3之间链路出现故障或闪断。所以心跳不是万能的，收到心跳可以确认节点正常，但是收不到心跳也不能认为该节点就已经宣告“死亡”。此时，可以通过一些方法帮助Server做决定： **周期检测心跳机制、累计失效检测机制**。

### 周期检测心跳机制

Server端每间隔 t 秒向Node集群发起监测请求，设定超时时间，如果超过超时时间，则判断“死亡”。

### 累计失效检测机制

在周期检测心跳机制的基础上，统计一定周期内节点的返回情况（包括超时及正确返回），以此计算节点的“死 亡”概率。另外，对于宣告“濒临死亡”的节点可以发起有限次数的重试，以作进一步判断。



**通过周期检测心跳机制、累计失效检测机制可以帮助判断节点是否“死亡”，如果判断“死亡”，可以把该节点踢出集群。**

## 2.高可用设计

高可用(High Availability)是系统架构设计中必须考虑的因素之一，通常是指，经过设计来减少系统不能提供服务的时间 。

![mark](http://blog.xuejiangtao.com/blog/20200708/ysVzngKoCr8k.png?imageslim)

据说阿里的分布式系统可以达到99.99999%，小数点后5个9。

### 1.主备模式

当主机宕机时，备机接管主机的一切工作，待主机恢复正常后，按使用者的设定以自动（热备）或手动（冷备）方式将服务切换到主机上运行。在数据库部分，习惯称之为MS模式。MS模式即Master/Slave模式，这在数据库高可用性方案中比较常用，如MySQL、Redis等就采用MS模式实现主从复制。保证高可用，如图所示：

![mark](http://blog.xuejiangtao.com/blog/20200708/edlEn7OkKgrA.png?imageslim)

数据库的主从复制原理为：

1. master将增删改操作的sql语句保存到**二进制日志**文件（binary log）中。

   这里需要注意的是旧版本的MySQL数据库默认是不开启二进制日志的，强烈建议在安装好数据库启动之前一定要先检查一下二进制日志文件是否开启，即使不做主从复制架构也要开启，否则当数据库启动之后再开启二进制日志时需要重新启动数据库。

2. 从数据库（Slave）开启一个IO工作线程，通过该IO线程与主数据库建立一个普通客户端连接，主数据库会启动一个二进制日志转储线程（binglog dump thread），从数据库的IO线程通过这个转储线程读取主库上的变更事件，并将变更事件记录到中继日志中（relay_log），如果从数据库的IO线程读取速度追赶上主库的事件变更，在没有得到新变更的通知时，IO线程会进入Sleep状态。
3. 从数据库还会启动一个SQL Thread线程，这个线程从中继日志（relay_log）中读取变更事件，并将变更同步到从数据库中。同时，可以通过配置选项，除了将变更存储到数据库中，也可以将变更事件同时存储在从数据库的二进制日志中。



#### 扩展：

##### 什么是二进制日志？

用来记录操作MySQL数据库执行更改的所有操作，但是不包括 select和show这类操作。二进制还包括了执行数据库更改操作的时间和执行时间等信息。

##### 二进制日志主要作用？

- 恢复 ：某些数据的恢复需要二进制日志，例如，在一个数据库全备文件恢复后，用户可以通过二进制日志进行point_in_time的恢复。
- 复制：其原理与恢复类似，通过复制和执行二进制日志使得一台远程的mysql数据库与一台mysql数据库进行实时同步。
- 审计： 用户可以通过二进制日志中的信息来进行审计，判断是否有对数据库进行注入的攻击。

##### mysq支持的日志格式

- Statement:基于语句，binlog中存储sql语句，存储日志量最小。（mysql默认的二进制日志格式）
- Row:基于行，存储event数据，存储日志量大，但是不能直接的进行读取。
- Mixed:介于Row和Statement之间，对于不确定的操作使用Row记录，如果每天数据量操作量很大，产生日志比较多，可以考虑选择Mixed 。

### 2.互备模式

<img src="http://blog.xuejiangtao.com/blog/20200709/LtpuNdOQxQEu.png?imageslim" alt="mark" style="zoom:50%;" />

1. 两台mysql都可读写，互为主备，默认只使用一台（masterA）负责数据的写入，另一台（masterB）备用；
2. masterA是masterB的主库，masterB又是masterA的主库，它们互为主从；
3. 两台主库之间做高可用,可以采用keepalived等方案（使用VIP对外提供服务）；
4. 所有提供服务的从服务器与masterB进行主从同步（双主多从）;
5. 建议采用高可用策略的时候，masterA或masterB均不因宕机恢复后而抢占VIP（非抢占模式）；

**优点：**

1. 这样做可以在一定程度上保证主库的高可用；

2. 在一台主库down掉之后，可以在极短的时间内切换到另一台主库上（尽可能减少主库宕机对业务造成的影响），减少了主从同步给线上主库带来的压力；

**缺点：**

1. masterB可能会一直处于空闲状态（可以用它当从库，负责部分查询）；

2. 主库后面提供服务的从库要等masterB先同步完了数据后才能去masterB上去同步数据，这样可能会造成一定程度的同步延时；

### 3.集群模式

集群模式是指有多个节点在运行，同时可以通过主控节点分担服务请求。如Zookeeper。集群模式需要解决主控节点本身的高可用问题，一般采用主备模式。

## 3.容错性

## 4.负载均衡

**负载均衡**：其关键在于使用多台集群服务器共同分担计算任务，把网络请求及计算分配到集群可用的不同服务器节点上，从而达到高可用性及较好的用户操作体验。

负载均衡器有**硬件解决方案**，也有软件解决方案。硬件解决方案有著名的F5，软件有LVS、HAProxy、Nginx等。

**软件解决方案**以Nginx为例，负载均衡有以下几种策略：

- 轮询：即Round Robin，根据Nginx配置文件中的顺序，依次把客户端的Web请求分发到不同的后端服务器。

- 最少连接：当前谁连接最少，分发给谁。

- IP地址哈希：确定相同IP请求可以转发给同一个后端节点处理，以方便session保持。

- 基于权重的负载均衡：配置Nginx把请求更多地分发到高配置的后端服务器上，把相对较少的请求分发到低配服务器。