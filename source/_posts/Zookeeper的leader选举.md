---
title: Zookeeper的leader选举
abbrlink: 6x507e72
date: 2020-8-3 0:31:44
tags: zookeeper
categories: zookeeper
keywords: zookeeper
---
# Zookeeper的leader选举

进行leader选举有两种情况：

```
1. 服务器启动时。
2. 服务器运行期间无法与leader保持连接。
```

## 1.服务器启动时leader选举

若要进行选举，必须要有超过2台以上的服务器，这里以3台服务器组成的集群为例。

服务器server1启动时，其单独无法完成选举。当服务器server2启动时，两台服务器进行通信，都试图找到leader，于是进入leader选举。过程如下：

### （1）每个server发送一个投票

由于是初始化，每个服务器将自己作为leader来进行投票。每次投票都包含（myid，ZXID）（服务器指定id，事务id），server1的投票信息为（1，0），server2的投票信息为（2，0），然后各自将投票信息发送给其他服务器。

### （2）接收各个服务器的投票

集群的每个服务器接收投票后，对投票信息进行有效性验证，如检查是否本轮投票，是否来自LOOKING状态的服务器。

### （3）处理投票

优先检查ZXID，ZXID大的服务器优先作为leader。

如果ZXID相同，那么比较myid，myid大的服务器作为leader服务器。

### （4）统计投票

每次投票后服务器都会统计所有投票，判断是否有过半服务器收到相同的投票信息。所谓过半是指，大于集群中服务器一半的数量，要大于等于（n/2+1）。

### （5）改变服务器状态

一旦确定了leader，每个服务器会更新自己的状态。如果是leader，改为LEADING；如果是follower，那么改为FOLLOWING。

## 2.服务器运行时期的leader选举

在ZooKeeper集群正常运行过程中，一旦选出一个Leader，那么所有服务器的集群角色一般不会再发生变化。也就是说，Leader服务器将**一直作为集群的Leader**，即使集群中有非Leader机器挂了，或是有新机器加入集群也不会影响Leader。

但是一旦Leader所在的机器挂了，那么整个集群将暂时无法对外服务，而是进入新一轮的Leader选举。服务器运行期间的Leader选举，和启动时期的Leader选举基本过程是一致的。

（1）变更状态

leader挂掉后，余下的非observer服务器都会将自己标记为looking状态，然后进入leader选举。

（2）每个server发出一个投票

各服务器都会为自己一票。既将投自己的票发送给集群中其他服务器。

（3）接收来自各个服务器的投票，与启动时过程相同

（4）处理投票。与启动时过程相同，此时，Server 1将会成为Leader

（5） 统计投票。与启动时过程相同

（6）改变服务器的状态。与启动时过程相同